<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Foglio Ore Autisti</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0d9488">
  <link rel="icon" href="icon-192.png">
  <style>
    :root { --pri:#0d9488; --bg:#f6f9fb; --card:#ffffff; --mut:#6b7280; }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:#0f172a;}
    header { position:sticky; top:0; background:var(--card); padding:12px; display:flex; gap:8px; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,.06); z-index:10;}
    h1 { font-size:18px; margin:0 8px 0 0; color:#0d9488; white-space:nowrap; }
    select, input[type="number"], input[type="text"], input[type="tel"] { padding:8px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; }
    main { padding:12px; }
    .row { background:var(--card); border-radius:14px; padding:12px; margin-bottom:10px; box-shadow:0 2px 8px rgba(0,0,0,.06); }
    .title { font-weight:600; margin-bottom:6px; }
    .grid3 { display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:6px; }
    .mut { color:#6b7280; font-size:12px; }
    .pair { display:flex; gap:6px; align-items:center; }
    .pair input { width:100%; }
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; background:#ecfeff; color:#0e7490; font-size:12px; margin-right:6px; }
    .footer { position:sticky; bottom:0; background:var(--card); padding:12px; box-shadow:0 -2px 8px rgba(0,0,0,.06); z-index:20; }
    button { padding:10px 14px; border:none; border-radius:12px; background:#0d9488; color:#fff; font-weight:600; cursor:pointer; }
    .inline { display:flex; gap:8px; flex-wrap:wrap; }
    .note { width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:10px; }
    .summary-table { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; }
    .summary-table .cell { background:#f0fdfa; padding:10px; border-radius:10px; text-align:center; }
    @media (max-width:900px){ .grid3{ grid-template-columns:1fr 1fr; } .summary-table{ grid-template-columns:1fr; } }
    @media (max-width:600px){ .grid3{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
<header>
  <h1>Foglio Ore</h1>
  <label class="mut">Mese
    <select id="month" title="Mese"></select>
  </label>
  <label class="mut">Anno
    <input type="number" id="year" style="width:100px" title="Anno"/>
  </label>
</header>

<main>
  <section class="row" id="headerCard">
    <div class="title">Intestazione</div>
    <div class="inline" style="width:100%">
      <input id="nome" placeholder="Nome e cognome" style="flex:1">
    </div>
    <div class="mut" style="margin-top:6px">Tipo di documento: <b>Specchio ore di lavoro</b></div>
    <div class="mut">Mansione: <b>Conducente</b></div>
    <small class="mut">Questi dati sono salvati solo sul dispositivo.</small>
  </section>

  <div id="days"></div>

  <section class="row" id="summaryCard">
    <div class="title">Resoconto mensile</div>
    <div class="summary-table">
      <div class="cell">Totale <b>pasti</b>: <span id="totPasti">0</span></div>
      <div class="cell">Totale <b>spese</b>: € <span id="totSpese">0.00</span></div>
      <div class="cell">Totale <b>ore di lavoro</b>: <span id="totOre">0.00</span></div>
    </div>
  </section>
</main>

<div class="footer">
  <div class="inline" style="justify-content:space-between; align-items:center">
    <small class="mut">Suggerimento: premi “Aggiungi a schermata Home” per installare l’app.</small>
    <div class="inline">
      <button id="exportPdf" type="button" style="background:#f59e0b">Esporta PDF</button>
      <button id="exportCsv" type="button">Esporta CSV</button>
      <button id="clearMonth" type="button" style="background:#ef4444">Svuota mese</button>
    </div>
  </div>
</div>

<script>
(function(){
const $ = s => document.querySelector(s);
const monthSel = $('#month'), yearInp = $('#year'), daysWrap = $('#days');
const nome=$('#nome');
const months = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
months.forEach((m,i)=>{ const o=document.createElement('option'); o.value=String(i+1); o.textContent=m; monthSel.appendChild(o); });
const now = new Date(); monthSel.value=String(now.getMonth()+1); yearInp.value=String(now.getFullYear());

function hdrLoad(){ try{const h=JSON.parse(localStorage.getItem('header')||'{}'); nome.value=h.nome||'';}catch(e){} }
function hdrSave(){ localStorage.setItem('header', JSON.stringify({nome:nome.value})); }
nome.addEventListener('input', hdrSave);

// time helpers: accept "hh:mm" or "hhmm"; auto-mask on input
function parseTime(s){
  if(!s) return null;
  const clean = s.replace(/[^\d:]/g,'');
  const m = /^(\d{1,2}):?(\d{2})$/.exec(clean);
  if(!m) return null;
  const h = +m[1], mi = +m[2];
  if(h>23 || mi>59) return null;
  return h*60+mi;
}
function formatToHHMM(s){
  let v = (s||'').replace(/\D/g,'');
  if(v.length>4) v = v.slice(0,4);
  if(v.length>=3) return v.slice(0,2).padStart(2,'0')+':'+v.slice(2).padEnd(2,'0').slice(0,2);
  if(v.length>=1) return v;
  return '';
}
function applyTimeMask(e){
  const before = e.target.value;
  const after = formatToHHMM(before);
  if(before !== after) e.target.value = after;
}
function hoursFromPairs(pairs){ let min=0; for(const p of pairs){ const a=parseTime(p[0]), b=parseTime(p[1]); if(a!=null&&b!=null&&b>a) min+=b-a; } return (min/60).toFixed(2); }

function buildDay(y,m,d){
  const date = new Date(y,m-1,d);
  const wk = date.toLocaleDateString('it-IT',{weekday:'short'});
  const id = `d:${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  let o={};
  try{o=JSON.parse(localStorage.getItem(id)||'{}');}catch(e){}
  if(o.meal !== undefined && o.meals === undefined){ o.meals = o.meal ? 1 : 0; } // retrocompatibilità
  const sec = document.createElement('section'); sec.className='row';
  sec.innerHTML = `
    <div class="title">${wk} ${String(d).padStart(2,'0')}</div>
    <div class="grid3">
      ${Array.from({length:6}).map((_,i)=>`
      <div class="pair">
        <small class="mut" style="width:24px">T${i+1}</small>
        <input class="in time" type="tel" placeholder="In hh:mm" inputmode="numeric">
        <input class="out time" type="tel" placeholder="Out hh:mm" inputmode="numeric">
      </div>`).join('')}
    </div>
    <div class="inline" style="align-items:center; gap:16px; margin-top:6px">
      <div class="pair" style="width:120px"><small class="mut" style="width:50px">Pasti</small><input class="meals" type="number" min="0" step="1" placeholder="n°"></div>
      <div class="pair" style="width:160px"><small class="mut" style="width:50px">Spese</small><input class="exp" type="number" step="0.01" inputmode="decimal" placeholder="€"></div>
      <input type="text" class="note" placeholder="Note" style="flex:1">
      <span class="badge">Ore giorno: <span class="od">0.00</span></span>
    </div>`;
  const timeInputs = sec.querySelectorAll('input.time');
  timeInputs.forEach(el=>{
    el.addEventListener('input', applyTimeMask);
  });
  const inputsIn = sec.querySelectorAll('.in');
  const inputsOut = sec.querySelectorAll('.out');
  const meals = sec.querySelector('.meals');
  const exp = sec.querySelector('.exp');
  const note = sec.querySelector('.note');
  const od = sec.querySelector('.od');
  const t = o.t||[];
  inputsIn.forEach((el,i)=>{ el.value = formatToHHMM(t[i]?.[0] || ''); });
  inputsOut.forEach((el,i)=>{ el.value = formatToHHMM(t[i]?.[1] || ''); });
  meals.value = (o.meals!=null) ? String(o.meals) : '';
  exp.value = (o.exp||o.exp===0) ? String(o.exp) : '';
  note.value = o.note || '';
  function save(){
    const pairs = Array.from({length:6}).map((_,i)=>[inputsIn[i].value, inputsOut[i].value]);
    od.textContent = hoursFromPairs(pairs);
    const data = { t:pairs, meals: parseInt(meals.value||'0'), exp: parseFloat((exp.value||'').replace(',','.'))||0, note: note.value };
    localStorage.setItem(id, JSON.stringify(data));
    totals();
  }
  inputsIn.forEach(el=>el.addEventListener('input', save));
  inputsOut.forEach(el=>el.addEventListener('input', save));
  ;[meals,exp,note].forEach(el=>el.addEventListener('input', save));
  // initial compute
  save();
  return sec;
}

function render(){
  const y = parseInt(yearInp.value) || new Date().getFullYear();
  const m = parseInt(monthSel.value) || (new Date().getMonth()+1);
  daysWrap.innerHTML='';
  const dim = new Date(y, m, 0).getDate();
  for(let d=1; d<=dim; d++){ daysWrap.appendChild(buildDay(y,m,d)); }
  totals();
}

function totals(){
  const y = parseInt(yearInp.value) || new Date().getFullYear();
  const m = parseInt(monthSel.value) || (new Date().getMonth()+1);
  const dim = new Date(y,m,0).getDate();
  let mealsSum=0, expSum=0, hours=0;
  for(let d=1; d<=dim; d++){
    let o={}; try{o=JSON.parse(localStorage.getItem(`d:${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`)||'{}');}catch(e){}
    mealsSum += parseInt(o.meals||0);
    expSum += (o.exp||0);
    if(o.t){ hours += parseFloat(hoursFromPairs(o.t)); }
  }
  document.getElementById('totPasti').textContent = mealsSum;
  document.getElementById('totSpese').textContent = expSum.toFixed(2);
  document.getElementById('totOre').textContent = hours.toFixed(2);
}

monthSel.addEventListener('change', render);
yearInp.addEventListener('change', render);

document.getElementById('clearMonth').addEventListener('click', (ev)=>{
  ev.preventDefault();
  const y=parseInt(yearInp.value)||new Date().getFullYear();
  const m=parseInt(monthSel.value)||(new Date().getMonth()+1);
  const dim=new Date(y,m,0).getDate();
  if(!confirm('Svuotare i dati del mese corrente?')) return;
  for(let d=1; d<=dim; d++){ localStorage.removeItem(`d:${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`); }
  render();
});

document.getElementById('exportCsv').addEventListener('click', (ev)=>{
  ev.preventDefault();
  const y=parseInt(yearInp.value)||new Date().getFullYear();
  const m=parseInt(monthSel.value)||(new Date().getMonth()+1);
  const dim=new Date(y,m,0).getDate();
  let csv='Data,Giorno,Pasti,Spese,Note,Ore\n';
  for(let d=1; d<=dim; d++){
    const date = new Date(y,m-1,d);
    const wk = date.toLocaleDateString('it-IT',{weekday:'short'});
    let o={}; try{o=JSON.parse(localStorage.getItem(`d:${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`)||'{}');}catch(e){}
    const hrs = o.t ? hoursFromPairs(o.t) : '0.00';
    csv += `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y},${wk},${parseInt(o.meals||0)},${(o.exp||0)},${(o.note||'').replace(/\n/g,' ').replace(/,/g,';')},${hrs}\n`;
  }
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`foglio_ore_${y}_${m}.csv`; a.click();
});

function makePdf(lines){
  const header='%PDF-1.3\n';
  const objs=[];
  objs.push('1 0 obj << /Type /Catalog /Pages 2 0 R >> endobj');
  objs.push('2 0 obj << /Type /Pages /Kids [3 0 R] /Count 1 >> endobj');
  let content='BT\n/F1 12 Tf\n';
  let yPos=800;
  for(const line of lines){
    const txt=line.replace(/([\\()])/g,'\\$1');
    content+=`1 0 0 1 50 ${yPos} Tm (${txt}) Tj\n`;
    yPos-=14;
  }
  content+='ET';
  objs.push('3 0 obj << /Type /Page /Parent 2 0 R /MediaBox [0 0 595 842] /Contents 4 0 R /Resources << /Font << /F1 5 0 R >> >> >> endobj');
  objs.push(`4 0 obj << /Length ${len(content)} >> stream\n${content}\nendstream endobj`);
  objs.push('5 0 obj << /Type /Font /Subtype /Type1 /BaseFont /Helvetica >> endobj');
  let body=''; offsets=[];
  for (let i=0;i<objs.length;i++){ const obj=objs[i]; offsets.push(header.length+body.length); body+=obj+'\n'; }
  const xrefOffset=header.length+body.length;
  let xref='xref\n0 6\n0000000000 65535 f \n';
  for(const off of offsets){ xref+=String(off).padStart(10,'0')+' 00000 n \n'; }
  return header+body+xref+`trailer << /Size 6 /Root 1 0 R >>\nstartxref\n${xrefOffset}\n%%EOF`;
}

document.getElementById('exportPdf').addEventListener('click', (ev)=>{
  ev.preventDefault();
  const y=parseInt(yearInp.value)||new Date().getFullYear();
  const m=parseInt(monthSel.value)||(new Date().getMonth()+1);
  const dim=new Date(y,m,0).getDate();
  const lines=['Data Giorno Pasti Spese Note Ore'];
  for(let d=1; d<=dim; d++){
    const date=new Date(y,m-1,d);
    const wk=date.toLocaleDateString('it-IT',{weekday:'short'});
    let o={}; try{o=JSON.parse(localStorage.getItem(`d:${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`)||'{}');}catch(e){}
    const hrs=o.t ? hoursFromPairs(o.t) : '0.00';
    lines.push(`${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y} ${wk} ${parseInt(o.meals||0)} ${(o.exp||0)} ${(o.note||'').replace(/\n/g,' ')} ${hrs}`);
  }
  const pdf=makePdf(lines);
  const blob=new Blob([pdf],{type:'application/pdf'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`foglio_ore_${y}_${m}.pdf`; a.click();
});

hdrLoad();
render();
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js') ); }
})();
</script>
</body>
</html>
