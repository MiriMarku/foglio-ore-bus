<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Foglio Ore Autisti</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0d9488">
  <link rel="icon" href="icon-192.png">
  <style>
    :root { --pri:#0d9488; --bg:#f6f9fb; --card:#ffffff; --mut:#6b7280; }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:#0f172a;}
    header { position:sticky; top:0; background:var(--card); padding:12px; display:flex; gap:8px; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,.06); z-index:10;}
    h1 { font-size:18px; margin:0 8px 0 0; color:var(--pri); }
    select, input[type="number"], input[type="text"] { padding:8px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; }
    main { padding:12px; }
    .row { background:var(--card); border-radius:14px; padding:12px; margin-bottom:10px; box-shadow:0 2px 8px rgba(0,0,0,.06); }
    .title { font-weight:600; margin-bottom:6px; }
    .grid3 { display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:6px; }
    .mut { color:var(--mut); font-size:12px; }
    .pair { display:flex; gap:6px; align-items:center; }
    .pair input { width:100%; }
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; background:#ecfeff; color:#0e7490; font-size:12px; margin-right:6px; }
    .footer { position:sticky; bottom:0; background:var(--card); padding:12px; box-shadow:0 -2px 8px rgba(0,0,0,.06); }
    button { padding:10px 14px; border:none; border-radius:12px; background:var(--pri); color:#fff; font-weight:600; cursor:pointer; }
    .inline { display:flex; gap:8px; flex-wrap:wrap; }
    .note { width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:10px; }
    @media (max-width:900px){ .grid3{ grid-template-columns:1fr 1fr; } }
    @media (max-width:600px){ .grid3{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
<header>
  <h1>Foglio Ore</h1>
  <label class="mut">Mese
    <select id="month" title="Mese"></select>
  </label>
  <label class="mut">Anno
    <input type="number" id="year" style="width:100px" title="Anno"/>
  </label>
</header>

<main>
  <section class="row">
    <div class="title">Intestazione</div>
    <div class="inline" style="width:100%">
      <input id="nome" placeholder="Nome" style="flex:1">
      <input id="documento" placeholder="Documento" style="flex:1">
      <input id="mansione" placeholder="Mansione" value="Conducente" style="flex:1">
    </div>
    <small class="mut">Dati salvati solo sul dispositivo.</small>
  </section>

  <div id="days"></div>
</main>

<div class="footer">
  <div class="inline" style="justify-content:space-between; align-items:center">
    <div>
      <span class="badge">Totale pasti: <span id="totPasti">0</span></span>
      <span class="badge">Totale spese: € <span id="totSpese">0.00</span></span>
      <span class="badge">Totale ore mese: <span id="totOre">0.00</span></span>
    </div>
    <div class="inline">
      <button id="exportCsv">Esporta CSV</button>
      <button id="clearMonth" style="background:#ef4444">Svuota mese</button>
    </div>
  </div>
</div>

<script>
(function(){
const $ = s => document.querySelector(s);
const monthSel = $('#month'), yearInp = $('#year'), daysWrap = $('#days');
const nome=$('#nome'), doc=$('#documento'), mansione=$('#mansione');
const months = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
months.forEach((m,i)=>{ const o=document.createElement('option'); o.value=String(i+1); o.textContent=m; monthSel.appendChild(o); });
const now = new Date(); monthSel.value=String(now.getMonth()+1); yearInp.value=String(now.getFullYear());

function hdrLoad(){ try{const h=JSON.parse(localStorage.getItem('header')||'{}'); nome.value=h.nome||''; doc.value=h.doc||''; mansione.value=h.mansione||'Conducente';}catch(e){} }
function hdrSave(){ localStorage.setItem('header', JSON.stringify({nome:nome.value, doc:doc.value, mansione:mansione.value})); }
[nome,doc,mansione].forEach(el=>el.addEventListener('input', hdrSave));

function k(y,m,d){ return `d:${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
function parseTime(s){ if(!s) return null; const m=/^(\d?\d):(\d\d)$/.exec(s.trim()); if(!m) return null; const h=+m[1], mi=+m[2]; if(h>23||mi>59) return null; return h*60+mi; }
function hoursFromPairs(pairs){ let min=0; for(const p of pairs){ const a=parseTime(p[0]), b=parseTime(p[1]); if(a!=null&&b!=null&&b>a) min+=b-a; } return (min/60).toFixed(2); }

function buildDay(y,m,d){
  const date = new Date(y,m-1,d);
  const wk = date.toLocaleDateString('it-IT',{weekday:'short'});
  const id = k(y,m,d);
  let o={};
  try{o=JSON.parse(localStorage.getItem(id)||'{}');}catch(e){}
  const sec = document.createElement('section'); sec.className='row';
  sec.innerHTML = `
    <div class="title">${wk} ${String(d).padStart(2,'0')}</div>
    <div class="grid3">
      ${Array.from({length:6}).map((_,i)=>`
      <div class="pair">
        <small class="mut" style="width:24px">T${i+1}</small>
        <input class="in" placeholder="In hh:mm" inputmode="numeric">
        <input class="out" placeholder="Out hh:mm" inputmode="numeric">
      </div>`).join('')}
    </div>
    <div class="inline" style="align-items:center; gap:16px; margin-top:6px">
      <label><input type="checkbox" class="meal"> Pasto</label>
      <input type="text" class="exp" placeholder="Spese (€)" inputmode="decimal" style="width:140px">
      <input type="text" class="note" placeholder="Note" style="flex:1">
      <span class="badge">Ore giorno: <span class="od">0.00</span></span>
    </div>`;
  const inputsIn = sec.querySelectorAll('.in');
  const inputsOut = sec.querySelectorAll('.out');
  const meal = sec.querySelector('.meal');
  const exp = sec.querySelector('.exp');
  const note = sec.querySelector('.note');
  const od = sec.querySelector('.od');
  // restore
  const t = o.t||[];
  inputsIn.forEach((el,i)=>{ el.value = t[i]?.[0] || ''; });
  inputsOut.forEach((el,i)=>{ el.value = t[i]?.[1] || ''; });
  meal.checked = !!o.meal;
  exp.value = (o.exp||o.exp===0) ? String(o.exp) : '';
  note.value = o.note || '';
  function save(){
    const pairs = Array.from({length:6}).map((_,i)=>[inputsIn[i].value, inputsOut[i].value]);
    od.textContent = hoursFromPairs(pairs);
    const data = { t:pairs, meal:meal.checked, exp: parseFloat((exp.value||'').replace(',','.'))||0, note: note.value };
    localStorage.setItem(id, JSON.stringify(data));
    totals();
  }
  inputsIn.forEach(el=>el.addEventListener('input', save));
  inputsOut.forEach(el=>el.addEventListener('input', save));
  ;[meal,exp,note].forEach(el=>el.addEventListener('input', save));
  save();
  return sec;
}

function render(){
  const y = parseInt(yearInp.value) || now.getFullYear();
  const m = parseInt(monthSel.value) || (now.getMonth()+1);
  daysWrap.innerHTML='';
  const dim = new Date(y, m, 0).getDate();
  for(let d=1; d<=dim; d++){ daysWrap.appendChild(buildDay(y,m,d)); }
  totals();
}

function totals(){
  const y = parseInt(yearInp.value) || now.getFullYear();
  const m = parseInt(monthSel.value) || (now.getMonth()+1);
  const dim = new Date(y,m,0).getDate();
  let meals=0, expSum=0, hours=0;
  for(let d=1; d<=dim; d++){
    let o={}; try{o=JSON.parse(localStorage.getItem(k(y,m,d))||'{}');}catch(e){}
    if(o.meal) meals++;
    expSum += (o.exp||0);
    if(o.t){ hours += parseFloat(hoursFromPairs(o.t)); }
  }
  document.getElementById('totPasti').textContent = meals;
  document.getElementById('totSpese').textContent = expSum.toFixed(2);
  document.getElementById('totOre').textContent = hours.toFixed(2);
}

document.getElementById('clearMonth').addEventListener('click', ()=>{
  if(!confirm('Svuotare i dati del mese corrente?')) return;
  const y=parseInt(yearInp.value)||now.getFullYear();
  const m=parseInt(monthSel.value)||(now.getMonth()+1);
  const dim=new Date(y,m,0).getDate();
  for(let d=1; d<=dim; d++){ localStorage.removeItem(k(y,m,d)); }
  render();
});

document.getElementById('exportCsv').addEventListener('click', ()=>{
  const y=parseInt(yearInp.value)||now.getFullYear();
  const m=parseInt(monthSel.value)||(now.getMonth()+1);
  const dim=new Date(y,m,0).getDate();
  let csv='Data,Giorno,Pasto,Spese,Note,Ore\n';
  for(let d=1; d<=dim; d++){
    const date = new Date(y,m-1,d);
    const wk = date.toLocaleDateString('it-IT',{weekday:'short'});
    let o={}; try{o=JSON.parse(localStorage.getItem(k(y,m,d))||'{}');}catch(e){}
    const hrs = o.t ? hoursFromPairs(o.t) : '0.00';
    csv += `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y},${wk},${o.meal?'SI':'NO'},${(o.exp||0)},${(o.note||'').replace(/\n/g,' ').replace(/,/g,';')},${hrs}\n`;
  }
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`foglio_ore_${y}_${m}.csv`; a.click();
});

hdrLoad();
render();
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js') ); }
})();
</script>
</body>
</html>
