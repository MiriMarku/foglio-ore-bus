<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Foglio Ore Autisti</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0d9488">
  <link rel="icon" href="icon-192.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root { --pri:#0d9488; --bg:#f6f9fb; --card:#ffffff; --mut:#6b7280; }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:#0f172a;}
    header { position:sticky; top:0; background:var(--card); padding:12px; display:flex; gap:8px; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,.06); z-index:10;}
    h1 { font-size:18px; margin:0 8px 0 0; color:var(--pri); white-space:nowrap; }
    select, input[type="number"], input[type="text"] { padding:8px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; }
    main { padding:12px; }
    .row { background:var(--card); border-radius:14px; padding:12px; margin-bottom:10px; box-shadow:0 2px 8px rgba(0,0,0,.06); }
    .title { font-weight:600; margin-bottom:6px; }
    .grid3 { display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:6px; }
    .mut { color:var(--mut); font-size:12px; }
    .pair { display:flex; gap:6px; align-items:center; }
    .pair input { width:100%; }
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; background:#ecfeff; color:#0e7490; font-size:12px; margin-right:6px; }
    .footer { position:sticky; bottom:0; background:var(--card); padding:12px; box-shadow:0 -2px 8px rgba(0,0,0,.06); z-index:20; }
    button { padding:10px 14px; border:none; border-radius:12px; background:var(--pri); color:#fff; font-weight:600; cursor:pointer; }
    .inline { display:flex; gap:8px; flex-wrap:wrap; }
    .note { width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:10px; }
    .summary-table { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; }
    .summary-table .cell { background:#f0fdfa; padding:10px; border-radius:10px; text-align:center; }
    @media (max-width:900px){ .grid3{ grid-template-columns:1fr 1fr; } .summary-table{ grid-template-columns:1fr; } }
    @media (max-width:600px){ .grid3{ grid-template-columns:1fr; } }
  </style>
@@ -50,50 +51,51 @@
    <div class="inline" style="width:100%">
      <input id="nome" placeholder="Nome e cognome" style="flex:1">
    </div>
    <div class="mut" style="margin-top:6px">Tipo di documento: <b>Specchio ore di lavoro</b></div>
    <div class="mut">Mansione: <b>Conducente</b></div>
    <small class="mut">Questi dati sono salvati solo sul dispositivo.</small>
  </section>

  <div id="days"></div>

  <section class="row" id="summaryCard">
    <div class="title">Resoconto mensile</div>
    <div class="summary-table">
      <div class="cell">Totale <b>pasti</b>: <span id="totPasti">0</span></div>
      <div class="cell">Totale <b>spese</b>: € <span id="totSpese">0.00</span></div>
      <div class="cell">Totale <b>ore di lavoro</b>: <span id="totOre">0.00</span></div>
    </div>
  </section>
</main>

<div class="footer">
  <div class="inline" style="justify-content:space-between; align-items:center">
    <small class="mut">Suggerimento: premi “Aggiungi a schermata Home” per installare l’app.</small>
    <div class="inline">
      <button id="exportCsv" type="button">Esporta CSV</button>
      <button id="exportPdf" type="button">Esporta PDF</button>
      <button id="clearMonth" type="button" style="background:#ef4444">Svuota mese</button>
    </div>
  </div>
</div>

<script>
(function(){
const $ = s => document.querySelector(s);
const monthSel = $('#month'), yearInp = $('#year'), daysWrap = $('#days');
const nome=$('#nome');
const months = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
months.forEach((m,i)=>{ const o=document.createElement('option'); o.value=String(i+1); o.textContent=m; monthSel.appendChild(o); });
const now = new Date(); monthSel.value=String(now.getMonth()+1); yearInp.value=String(now.getFullYear());

function hdrLoad(){ try{const h=JSON.parse(localStorage.getItem('header')||'{}'); nome.value=h.nome||'';}catch(e){} }
function hdrSave(){ localStorage.setItem('header', JSON.stringify({nome:nome.value})); }
nome.addEventListener('input', hdrSave);

function k(y,m,d){ return `d:${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
function parseTime(s){ if(!s) return null; const m=/^(\d?\d):(\d\d)$/.exec(s.trim()); if(!m) return null; const h=+m[1], mi=+m[2]; if(h>23||mi>59) return null; return h*60+mi; }
function hoursFromPairs(pairs){ let min=0; for(const p of pairs){ const a=parseTime(p[0]), b=parseTime(p[1]); if(a!=null&&b!=null&&b>a) min+=b-a; } return (min/60).toFixed(2); }

function buildDay(y,m,d){
  const date = new Date(y,m-1,d);
  const wk = date.toLocaleDateString('it-IT',{weekday:'short'});
@@ -177,32 +179,60 @@ document.getElementById('clearMonth').addEventListener('click', (ev)=>{
  const y=parseInt(yearInp.value)||now.getFullYear();
  const m=parseInt(monthSel.value)||(now.getMonth()+1);
  const dim=new Date(y,m,0).getDate();
  if(!confirm('Svuotare i dati del mese corrente?')) return;
  for(let d=1; d<=dim; d++){ localStorage.removeItem(k(y,m,d)); }
  render();
});

document.getElementById('exportCsv').addEventListener('click', (ev)=>{
  ev.preventDefault();
  const y=parseInt(yearInp.value)||now.getFullYear();
  const m=parseInt(monthSel.value)||(now.getMonth()+1);
  const dim=new Date(y,m,0).getDate();
  let csv='Data,Giorno,Pasti,Spese,Note,Ore\n';
  for(let d=1; d<=dim; d++){
    const date = new Date(y,m-1,d);
    const wk = date.toLocaleDateString('it-IT',{weekday:'short'});
    let o={}; try{o=JSON.parse(localStorage.getItem(k(y,m,d))||'{}');}catch(e){}
    const hrs = o.t ? hoursFromPairs(o.t) : '0.00';
    csv += `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y},${wk},${parseInt(o.meals||0)},${(o.exp||0)},${(o.note||'').replace(/\n/g,' ').replace(/,/g,';')},${hrs}\n`;
  }
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`foglio_ore_${y}_${m}.csv`; a.click();
});

document.getElementById('exportPdf').addEventListener('click', (ev)=>{
  ev.preventDefault();
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const y=parseInt(yearInp.value)||now.getFullYear();
  const m=parseInt(monthSel.value)||(now.getMonth()+1);
  const dim=new Date(y,m,0).getDate();
  doc.setFontSize(16);
  doc.text(`Foglio ore ${months[m-1]} ${y}`,10,10);
  let yPos=20;
  doc.setFontSize(10);
  function addLine(line){
    if(yPos>280){ doc.addPage(); yPos=10; }
    doc.text(line,10,yPos);
    yPos+=6;
  }
  addLine('Data Giorno Pasti Spese Note Ore');
  for(let d=1; d<=dim; d++){
    const date = new Date(y,m-1,d);
    const wk = date.toLocaleDateString('it-IT',{weekday:'short'});
    let o={}; try{o=JSON.parse(localStorage.getItem(k(y,m,d))||'{}');}catch(e){}
    const hrs = o.t ? hoursFromPairs(o.t) : '0.00';
    const line=`${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y} ${wk} ${parseInt(o.meals||0)} ${(o.exp||0).toFixed(2)} ${(o.note||'').replace(/\n/g,' ')} ${hrs}`;
    addLine(line);
  }
  doc.save(`foglio_ore_${y}_${m}.pdf`);
});

hdrLoad();
render();
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js') ); }
})();
</script>
</body>
</html>
